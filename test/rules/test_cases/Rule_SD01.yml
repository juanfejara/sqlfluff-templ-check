rule: SD01

forbidden_hardcoded_table:
  fail_str: |
    select
      bar,
      baz
    from tbl
    order by bar

forbidden_from_multiples_reference:
  fail_str: |
    select
      a.a,
      sum(b.b)
    from {{ ref('tbl') }} as a, tbl2 as b

regular_from_multiples_reference:
  pass_str: |
    select
      t1.a,
      sum(t2.b)
    from {{ ref('tbl') }} as t1, {{ ref('tbl2') }} as t2

regular_from_reference:
  pass_str: |
    select
      a,
      sum(b)
    from {{ ref('tbl') }}
    group by a
    order by a

regular_join_reference:
  pass_str: |
    select
      t1.a,
      t1.b,
      t1.c
    from {{ ref('tbl') }} as t1
    inner join {{ ref('tbl2') }} as t2 on t2.a = t1.a

forbidden_regular_from_plus_join_reference:
  fail_str: |
    select
      t1.a,
      t1.b,
      t1.c
    from tbl as t1
    inner join tbl2 as t2 on t2.a = t1.a

regular_from_plus_forbidden join_reference:
  fail_str: |
    select
      t1.a,
      t1.b,
      t1.c
    from {{ ref('tbl') }} as t1
    inner join tbl2 as t2 on t2.a = t1.a

regular_forbidden_multiple_join_reference:
  fail_str: |
    select
      t1.a,
      t1.b,
      t1.c
    from {{ ref('tbl') }} as t1
    inner join {{ ref('tbl2') }} as t2 on t2.a = t1.a
    inner join tbl3 as t3 on t3.b = t1.b

forbidden_regular_join_reference:
  fail_str: |
    select
      t1.a,
      t1.b,
      t1.c
    from {{ ref('tbl') }} t1
    inner join tbl2 as t2 on t2.a = t1.a

regular_join_reference_with_source_in_from:
  pass_str: |
    select
      a,
      b,
      c
    from {{ source('compatibility', 'tbl2') }}

regular_join_reference_with_source_instead:
  pass_str: |
    select
      t1.a,
      t1.b,
      t1.c
    from {{ ref('tbl') }} as t1
    inner join {{ source('compatibility', 'tbl2') }} as t2 on t2.a = t1.a

forbidden_invalid_reference_in_nested_query_on_join:
  fail_str: |
    select
      tb1.a,
      sum(tb2.b)
    from {{ ref('tbl1') }} as tb1
    inner join (select * from tbl2) as t2 on t2.a = t1.a
    group by a
    order by a


regular_from_a_select_with_reference:
  pass_str: |
    select
      a,
      sum(b)
    from (select * from {{ ref('tbl') }})
    group by a
    order by a

regular_from_a_select_with_invalid_reference:
  fail_str: |
    select
      a,
      sum(b)
    from (select * from tbl)
    group by a
    order by a

forbidden_from_multiple_select_with_invalid_reference:
  fail_str: |
    select
      tb1.a,
      sum(tb2.b)
    from (select * from {{ ref('tbl') }}) as tb1, (select * from tbl2) as tb2
    group by a
    order by a

regular_extract_exception:
  pass_str: |
    select
      extract(day from a),
      b,
      c
    from {{ ref('tbl') }}
    inner join {{ ref('tbl2') }}

allowed_alias_reference:
  pass_str: |
    with allow_alias as (
      select
        bar,
        baz
      from {{ ref('tbl') }}
    )
    , another_alias as (
      select
        bar,
        baz
      from {{ ref('tbl2') }}
    )
    select
      bar,
      baz
    from allow_alias

not_allowed_reference_in_alias:
  fail_str: |
    with allow_alias as (
      select
        bar,
        baz
      from tbl1
    )
    , another_alias as (
      select
        bar,
        baz
      from {{ ref('tbl2') }}
    )
    select
      bar,
      baz
    from allow_alias
